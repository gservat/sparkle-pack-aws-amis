#!/usr/bin/env ruby
require 'net/http'
require 'json'
require 'pp'

raw_data = JSON.parse(Net::HTTP.get('cloud-images.ubuntu.com','/releases/streams/v1/com.ubuntu.cloud:released:aws.json'))


amis = raw_data['products']

ami_hash = {}

stable = amis.select { |k,v| v['release_title'].include?("LTS") }

stable.each do |product,versions|
  ami_hash[versions['release']] = {}
  versions['versions'].each do |date,items|
    ami_hash[versions['release']][date] = { 'amis' => {} } unless ami_hash[versions['release']][date].is_a?(Hash)
    items['items'].each do |item, info|
      ami_hash[versions['release']][date]['amis'][info['crsn']] = {} unless ami_hash[versions['release']][date]['amis'][info['crsn']].is_a?(Hash)
      ami_hash[versions['release']][date]['amis'][info['crsn']][info['virt']] = {} unless ami_hash[versions['release']][date]['amis'][info['crsn']][info['virt']].is_a?(Hash)
          ami_hash[versions['release']][date]['amis'][info['crsn']][info['virt']][info['root_store']] = info['id']
    end
  end
end

ami_hash.keys.each do |key|

  hash = {
    'latest' => ami_hash[key].keys.max,
    'version' => key,
    'releases' => ami_hash[key]
  }

  File.open("lib/sparkleformation/registry/#{key}.rb", 'w') do |file|
    file.write("SfnRegistry.register(:#{key}_amis) do\n#{hash.pretty_inspect}\nend")
  end
end
